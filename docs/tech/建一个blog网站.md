---
title: å»ºä¸€ä¸ªblogç½‘ç«™
description: VitePress å»ºä¸€ä¸ªblogç½‘ç«™
export: true
tags:
  - project
  - web
keys:
  - vitepress
---

::: info Introduction

å»ºç«™çš„è¿‡ç¨‹ã€‚ç½‘ç«™çš„å†…å®¹å»ºè®®ï¼›vitepressçš„ä¸€äº›ä¸ªæ€§åŒ–é…ç½®,æ–‡ç« åˆ†ç±»æ’åºç­‰ï¼›å…³äºå‘å¸ƒï¼šå®ç°sshåœ¨äº‘æœåŠ¡å™¨ä¸Šå†™blog,æ¯æ¬¡commitåè‡ªåŠ¨å‘å¸ƒã€‚

:::

## å»ºç«™çš„å‡†å¤‡


**ç›®çš„ï¼š**

[æ‰“é€ ä¸ªäººå“ç‰Œ](/docs/life/å®è·µ/è¡ŒåŠ¨/æ‰“é€ ä¸ªäººå“ç‰Œ.md)ã€‚ä½†ä¸»è¦çš„åŸå› æ˜¯ï¼šæ­£å¥½æœ‰ä¸€å°äº‘æœåŠ¡å™¨,å†ä¹°ä¸ªä¾¿å®œçš„åŸŸåå°±å¯ä»¥äº†

**å†…å®¹ï¼š**

blog æœ€é‡è¦çš„æ˜¯å†…å®¹.

åº”è¯¥å†™ä»€ä¹ˆå†…å®¹ï¼Œä¸åº”è¯¥å†™ä»€ä¹ˆå†…å®¹ï¼Ÿä¸‹é¢æ˜¯ç»™è‡ªå·±çš„å»ºè®®ã€‚

- æŠ€æœ¯blogã€‚æŒæ¡ä¸€ä»¶äº‹æƒ…ï¼Œæœ€å¥½æ˜¯èƒ½å¤ŸæŠŠå®ƒåšå‡ºæ¥ï¼Œå…¶æ¬¡æ˜¯èƒ½å¤ŸæŠŠå®ƒè®²æ˜ç™½ã€‚æŠŠè¯è®²ç»™åˆ«äººå¬ï¼Œè¿˜éœ€è¦è¡¨è¾¾èƒ½åŠ›ï¼Œä½†æ˜¯ï¼Œå¦‚æœè‡ªå·±æ¸…æ¥šï¼Œå³ä½¿è¡¨è¾¾èƒ½åŠ›æ¬ ä½³ï¼Œæœ€ç»ˆä¹Ÿæ˜¯è‚¯å®šèƒ½å¤Ÿè®²æ˜ç™½çš„ã€‚å†™blogä¹Ÿèƒ½é”»ç‚¼è¡¨è¾¾èƒ½åŠ›ï¼Œä½ ä¸€ç›´åœ¨æ€è€ƒï¼Œä½ çš„è¯»è€…å¯ä»¥ä»æ­¤æ–‡ç« è·å¾—ä»€ä¹ˆã€‚
- å­¦ä¹ ç¬”è®°å’ŒçŸ¥è¯†ç‚¹å¤‡å¿˜å½•ã€‚åªæœ‰å¤§ä½¬æ‰èƒ½å¤Ÿå†™è¶³å¤Ÿä¼˜ç§€çš„åšå®¢ï¼Œåœ¨æ­¤ä¹‹å‰åšä¸€äº›å­¦ä¹ ç¬”è®°ä¹Ÿæ˜¯å¯¹è‡ªå·±å’Œåˆ«äººéƒ½æœ‰ä»·å€¼çš„ã€‚
- è®²è¿°ä¸ªäººæ•…äº‹ã€‚æŠ€æœ¯åªæ˜¯ç”Ÿæ´»çš„ä¸€éƒ¨åˆ†ã€‚ä¸€ä¸ªäººçš„ç”Ÿæ´»æ›´å—ä¸ªäººä»·å€¼è§‚å’Œè¡Œä¸ºçš„å½±å“ã€‚ä¸æŠ€æœ¯çš„é€šç”¨æ€§ä¸åŒï¼Œä»·å€¼è§‚å’Œè¡Œä¸ºæ²¡æœ‰æ™®é€‚æ€§ï¼Œä½†å¥½çš„ä»·å€¼è§‚å’Œè¡Œä¸ºåˆ©äººåˆ©å·±ï¼Œä¹Ÿå®¹æ˜“è¢«åˆ«äººæ¥å—ã€‚ä»·å€¼è§‚å’Œè¡Œä¸ºå¯ä»¥åŸ¹å…»ï¼Œå¯ä»¥æ”¹å˜ï¼Œè®²è¿°ä¸ªäººæ•…äº‹ä¹Ÿæ˜¯blogçš„ä¸€éƒ¨åˆ†ã€‚
- å†…å®¹æ˜¯é€‚å®œå…¬å¼€çš„å†…å®¹ï¼Œè¿™ä¸æ˜¯ä¸ªäººçš„æ—¥è®°ï¼Œåº”å½“åé‡ç»“æœï¼Œè€Œä¸æ˜¯è¿‡ç¨‹ï¼Œå½“ç„¶æœ‰æ—¶å€™è¿‡ç¨‹å°±æ˜¯ç»“æœã€‚ä¸è¦å†™æ²¡æœ‰ç”¨çš„å†…å®¹ï¼Œå†™æœ‰ä»·å€¼çš„å†…å®¹ï¼Œä¾‹å¦‚ï¼šæè¿°ä½ çš„æƒ…ç»ªçš„å˜åŒ–ï¼›è¿›å–ç²¾ç¥ï¼›æè¿°ä½ è¿˜æ²¡æœ‰å®ç°çš„ç›®æ ‡å’Œè®¡åˆ’ç­‰ç­‰éƒ½æ²¡ä»€ä¹ˆç”¨ï¼Œè¿™é‡Œçš„æ²¡æœ‰ç”¨æ˜¯æŒ‡å¯¹åˆ«äººæ²¡æœ‰ç”¨ã€‚éœ¸é“æ€»è£æ€»è¯´ï¼šæˆ‘åªè¦ç»“æœã€‚å¹´è½»çš„æ—¶å…‰å·²ç»è¿‡å»ï¼Œåªæœ‰å®åŠ›èƒ½å¤Ÿæ‰“åŠ¨åˆ«äººï¼Œå¤±è´¥çš„åŸå› é€šå¸¸ä¹Ÿå‘æŒ¥ç€å€Ÿå£çš„ä½œç”¨ã€‚
- æ³¨é‡è´¨é‡ï¼Œè€Œéæ•°é‡ã€‚åšä¸€ä»¶å¥½çš„äº‹æƒ…ï¼Œæ¯”å¾—ä¸Šåšåä»¶å¹³åº¸çš„äº‹æƒ…ï¼›å†™ä¸€ç¯‡å¥½çš„åšå®¢ï¼Œä¹Ÿè¶…è¿‡10ç¯‡ä¸€èˆ¬çš„åšå®¢ï¼Œåœ¨æœ€å¼€å§‹ï¼Œå¯¹æœ‰ä»·å€¼çš„blogå¯ä»¥ä¸€ç›´ä¿®æ”¹ï¼Œç›´åˆ°æ”¹ä¸åŠ¨ä¸ºæ­¢ã€‚
- ä¸ªäººå…¬å¼€blogçš„ä¸€éƒ¨åˆ†ä½œç”¨ä¹Ÿå¯ä»¥ç†è§£ä¸ºï¼Œä¸»åŠ¨ç»™è‡ªå·±è´´ä¸€äº›æ ‡ç­¾ï¼Œå¹¶è¯•å›¾è®©åˆ«äººè®¤å¯ã€‚ä¸åº”è¯¥éšä¾¿è´´æ ‡ç­¾ï¼Œä½†æ ‡ç­¾ç¡®å®èƒ½æ›´å®¹æ˜“è®©äººå½¢æˆä¸€äº›å…·ä½“çš„å°è±¡ï¼Œå³ä½¿è¿™äº›å°è±¡å¾€å¾€æ˜¯é”™è¯¯çš„ï¼Œæ—¢ç„¶æ ‡ç­¾å®¢è§‚å­˜åœ¨ï¼Œå¹¶æœ‰ä½œç”¨ï¼Œå°±ä¸»åŠ¨ç»™è‡ªå·±è´´ä¸€äº›ç§¯æçš„æ ‡ç­¾ã€‚è®¸å¤šäº‹æƒ…éƒ½æ˜¯å¤æ‚çš„ï¼Œä»ä¸åŒçš„è§†è§’çœ‹ï¼Œä¼šæœ‰ä¸åŒçš„æ˜ åƒï¼Œè´´ç§¯æçš„æ ‡ç­¾å°±æ˜¯ä¸ºåˆ«äººè°ƒæ•´ä¸€ä¸ªé¦–å…ˆè‡ªå·±æ»¡æ„çš„è§†è§’æ¥è§‚å¯Ÿè‡ªå·±ã€‚è™šå‡æ ‡ç­¾æ²¡æœ‰ç”¨ï¼Œè¿™é‡Œæ ¹æœ¬éª—ä¸åˆ°äººã€‚


**åŸºç¡€ææ–™ï¼š**

1. äº‘æœåŠ¡å™¨ï¼Œä¸€èˆ¬é™„èµ å…¬ç½‘ip
2. ä¸€ä¸ªåŸŸåï¼Œå¾ˆä¾¿å®œçš„
3. sslè¯ä¹¦ï¼Œç”¨äºhttpsã€‚[^1]

## å‰ç«¯å·¥å…·(vitepress)

æœ‰ä¸€å †åˆé€‚çš„å·¥å…·ã€‚æˆ‘é€‰æ‹©äº† vitepress ï¼ŒåŸå› æ˜¯æˆ‘å¯¹vueç†Ÿæ‚‰ã€‚æœ€å¼€å§‹ï¼Œä¸ºäº†å¿«é€Ÿå®Œæˆç›®æ ‡ï¼Œæˆ‘ä½¿ç”¨äº†naiveuiçš„ä¸€äº›ç»„ä»¶ï¼Œåé¢å‡ºäºå‡å°‘é¡¹ç›®ä¾èµ–çš„ç›®çš„ï¼Œå»æ‰äº†naiveuiï¼Œè‡ªå·±å®ç°äº†æˆ‘éœ€è¦çš„ç®€å•çš„ç»„ä»¶ã€‚

å¦‚æœæƒ³ç»™ä¸€ä¸ªé¡¹ç›®æä¾›å‚è€ƒæ–‡æ¡£ï¼Œvitepress å¼€ç®±å³ç”¨ã€‚ä½†è‹¥æƒ³ç”¨ vitepress æ­å»ºä¸ªäººç½‘ç«™ï¼Œé€šå¸¸éœ€è¦åšä¸€äº›ä¸ªæ€§åŒ–çš„é…ç½®ï¼Œåšè¿™äº›é…ç½®ååˆ†ç®€å•ã€‚[^2]

å¯¹äº vitepress çš„ä½¿ç”¨ï¼Œåº”å½“æœ‰ä»¥ä¸‹è®¤è¯†ï¼š

- vitepress å°†markdown ç¼–è¯‘æˆ html , å®ƒæ˜¯ssrçš„ï¼Œä¸€äº›å…ƒæ•°æ®(åŸºæœ¬æ˜¯blogæ–‡ç« æ•°æ®)å¯ä»¥åœ¨ç¼–è¯‘æœŸé—´è·å¾—ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ’ä»¶çš„æ–¹å¼ï¼Œæ§åˆ¶ç¼–è¯‘è¿‡ç¨‹ï¼Œç”Ÿæˆä¸ªæ€§åŒ–çš„ç»“æœï¼Œä¾‹å¦‚ mermaidJs å›¾, ä¹Ÿå› ä¸ºæ˜¯ssrï¼Œæ‰€ä»¥ä¸€äº›ç»„ä»¶æˆ–è€…åŠŸèƒ½çš„ä½¿ç”¨ä¼šå—ä¸€äº›é™åˆ¶ã€‚
- vitepress çš„ä¸ªæ€§åŒ–é…ç½®å°±æ˜¯ vueï¼ŒåŸºæœ¬ä¸Švueå¯ä»¥ç”¨çš„ä¸œè¥¿ï¼Œvitepresséƒ½å¯ä»¥ç”¨,ä¼švueä½¿ç”¨vitepresså°±ä¸ç”¨é¢å¤–å­¦æ–°çš„ä¸œè¥¿ã€‚
- æœ€å¸¸è§çš„ä¸ªæ€§åŒ–é…ç½®æ˜¯ä¸»é¢˜æ ·å¼å’Œä¸»é¡µã€‚


::: tip

é™¤vitepressä¹‹å¤–ï¼Œé€‚åˆæ„å»ºä¸ªäººç½‘ç«™çš„å·¥å…·æˆ–æ–¹å¼è¿˜æœ‰:
- hexo
  - è¿™æ˜¯æˆç†Ÿçš„ä¸“ä¸šåšå®¢æ¡†æ¶ï¼Œæœ‰å¾ˆå¤šä¸»é¢˜å¯ä»¥ä½¿ç”¨ã€‚æˆ‘æ²¡æœ‰ä½¿ç”¨å®ƒæ˜¯å› ä¸ºä¸€çœ¼çœ‹ä¸Šå»ï¼Œå°±æ„Ÿè§‰å®ƒå¾ˆå¤æ‚ã€‚æˆç†ŸåŒæ—¶æ„å‘³ç€æƒ³æ”¹ä¸€äº›ä¸œè¥¿å°±å¯èƒ½ä¼šéº»çƒ¦ã€‚æ€»æœ‰ä¸€äº›åœ°æ–¹ä¼šä¸æ»¡æ„ã€‚
- è‡ªå·±ä»é›¶åš
  - æœ€åˆçš„æ—¶å€™ï¼Œæˆ‘å‡†å¤‡è¿™æ ·åšã€‚å€ŸåŠ©æˆç†Ÿçš„åº“ä¾‹å¦‚ markdown-it ç­‰ï¼Œåšä¸»ä½“åŠŸèƒ½å¹¶ä¸éº»çƒ¦ï¼Œä½†æ˜¯æ¶‰åŠåˆ°ä¸€äº›ç»†èŠ‚çš„åœ°æ–¹ï¼Œå°±æœ‰éå¸¸å¤šçš„å·¥ä½œé‡ï¼Œ[æˆ‘ä¸æƒ³æ·±å…¥æŒæ¡å‰ç«¯](/),æ‰€ä»¥æœ‰è½®å­ç”¨å°±ä¸è¦æŠ˜è…¾ã€‚
- Docusaurus
  - ä¸ vitepress å¯¹åº”ï¼Œæ˜¯react ç›¸å…³ã€‚æˆ‘ä¸ä¼š reactã€‚
- vuepress
  - vitepress æ˜¯æ–°ä¸€ä»£ç‰ˆæœ¬ï¼Œç”¨ vitepressã€‚
:::


### 1. å®ç°ç³»åˆ—ç›®å½•çš„è‡ªåŠ¨ç”Ÿæˆ

> è¿™ä¸ªğŸ‘‡

![Alt text](/asserts/sidebar.png)

æœ‰æ—¶å€™å†™çš„æ–‡ç« æ˜¯ä¸€ç³»åˆ—æ–‡ç« ï¼Œå®ƒåº”å½“ç”±å¤šä¸ªæ–‡ç« ç»„åˆæˆä¸€ä¸ªç›®å½•ã€‚vitepress æ”¯æŒå¤šçº§ç›®å½•ã€‚ç°åœ¨æ˜¯æƒ³è®©ç›®å½•æ ¹æ®ä¸€äº›æç¤ºè‡ªåŠ¨ç”Ÿæˆã€‚

ä½¿ç”¨ `vite-plugin-vitepress-auto-sidebar` æ’ä»¶ã€‚åœ¨ `config.ts` æ–‡ä»¶ä¸­ä½¿ç”¨æ’ä»¶:

```ts {3,5,8}
/****************************** config.ts ***********************************************************/
  vite: {
    plugins: [
      // add plugin
      AutoSidebar({
        path: "/",
        collapsed:true,
        sideBarResolved: (data) => {
          let d =filterDocsSideBar(data)
          // ä½¿ç”¨tsçš„åŸå› æ˜¯ï¼šå†™ä»£ç çš„æ—¶å€™ï¼Œtsç»™æˆ‘ä¸€äº›æç¤ºï¼Œå®ƒé¿å…äº†ä¸€äº›æ½œåœ¨çš„é”™è¯¯ï¼ŒåŒæ—¶æœ‰lintçš„ä½œç”¨
          // ä½†æˆ‘ä½¿ç”¨tsçš„å¤§éƒ¨åˆ†æ„Ÿå—æ˜¯ï¼šæˆ‘æ˜¯å¯¹çš„ï¼Œæˆ‘çŸ¥é“ï¼Œä¸è¦æŠ¥é”™ï¼Œæˆ‘ä¸æƒ³å†™å¤šä½™çš„ä¸œè¥¿
           return d as any
        },
      }),
      htmlImport() as any,
    ],
  }

/*********************************** åŠŸèƒ½å‡½æ•°******************************************************/
/**
 * è·å–sidebar ç›®å½•,å½“ç›®å½•ä¸‹çš„æ–‡ä»¶åŒ…å«'_ca'æ—¶ï¼Œå°†ä¼šåœ¨æ­¤æ–‡ä»¶ä¸‹ç”Ÿæˆä¸€ä¸ªsidebar ç›®å½•
 * @param {*} item autoside object
 * @returns
 */
export function filterDocsSideBar(item) {
    let beforItems = item['/docs/'][0].items
    let afterItems = {}
    filterDocsSideBarWork(beforItems, afterItems, '/docs/')
    return afterItems
}
function filterDocsSideBarWork(beforItems, willInsertItems, prefix) {
    for (let i = 0; i < beforItems.length; ++i) {
        if (beforItems[i].items) {
            var nprefix = prefix + beforItems[i].text + '/'
            if (beforItems[i].text.includes('_ca')) {
                beforItems[i].text = beforItems[i].text.replace('_ca', '')
                willInsertItems[nprefix] = [beforItems[i]]
            } else {
                filterDocsSideBarWork(beforItems[i].items, willInsertItems, nprefix)
            }
        }
    }

}
```
è¿™æ ·å½“æ–‡ä»¶å¤¹ç›®å½•ä¸­æœ‰â€˜_caâ€™ï¼Œå°±ä¼šä¸ºè¿™ä¸ªç›®å½•ä¸‹æ‰€æœ‰çš„æ–‡ç« ç”Ÿæˆä¸€ä¸ªsidebar,å½“è®¿é—®æ­¤ç›®å½•ä¸‹çš„æ–‡ç« æ—¶ï¼Œsidebarå°±ä¼šåœ¨ç•Œé¢å·¦è¾¹å‡ºç°ã€‚


### 2. å®ç°æ–‡ç« åˆ†ç±»æ’åºå±•ç¤º

æˆ‘å¸Œæœ›æ–‡ç« æœ‰ä¸€ä¸ªåˆ—è¡¨é¡µé¢ï¼Œå¹¶å´æŒ‰ç…§åˆ†ç±»å±•ç¤ºã€‚

æ•´ä½“æ€è·¯æ˜¯ï¼šé¦–å…ˆè·å–æ–‡ç« çš„å…ƒæ•°æ®ï¼Œä¹‹åå¯¹å…ƒæ•°æ®åŠ å·¥ï¼Œåœ¨ç›¸åº”çš„é¡µé¢å¯¹è¿™äº›å…ƒæ•°æ®åˆ†ç±»æ’åºç­‰ã€‚

`globby`ç­‰æ’ä»¶å¯ä»¥å¸®åŠ©è·å–å…ƒæ•°æ®ã€‚åœ¨å±•ç¤ºæ•°æ®çš„æ—¶å€™ï¼Œæˆ‘ä½¿ç”¨äº†`naive-ui`çš„ä¸€äº›ç»„ä»¶ã€‚

é¦–é¡µå±•ç¤ºçš„ç»„ä»¶åˆšå¼€å§‹å€ŸåŠ©äºnaive-uiï¼Œåé¢è‡ªå·±å®ç°äº†ï¼Œè¿™å‡å°‘äº†å‘å¸ƒæ—¶é—´ï¼Œssræ›´åŠ é¡ºåˆ©ã€‚æˆ‘è¿˜ä½¿ç”¨äº†`vue-virtual-scroller`è§£å†³åç»­éšç€blogå¢å¤šï¼Œä¸»é¡µé¢å¡é¡¿çš„é—®é¢˜ï¼Œç°åœ¨ç»ˆæˆ‘ä¸€ç”Ÿï¼Œæˆ‘ä¹Ÿå†™ä¸å‡ºèƒ½è®©æˆ‘ä¸»é¡µé¢å¡é¡¿æ•°é‡çš„blogsã€‚

## åå°æ‰˜ç®¡

vitepress ç”Ÿæˆçš„æ˜¯çº¯çº¯é™æ€é¡µé¢ï¼Œæœ€å¸¸ç”¨çš„æ‰˜ç®¡æ–¹å¼æ˜¯ä½¿ç”¨nginxã€‚ä½†å°±ä»…ä»…æ‰˜ç®¡ä¸€ä¸ªé™æ€é¡µé¢ï¼Œngxinxè¿˜æ˜¯æœ‰ç‚¹æ²‰é‡ã€‚ä½¿ç”¨c++ å†™ä¸ªç®€å•çš„æ‰˜ç®¡é™æ€èµ„æºçš„web serverï¼Œå ç”¨èµ„æºæå°‘ï¼Œæ€§èƒ½è¾ƒé«˜ï¼Œè€Œä¸”ååˆ†ç®€å•ã€‚

æˆ‘é€‰æ‹©ä½¿ç”¨ `drogon`[^3]ã€‚

## éƒ¨ç½²ä¸å‘å¸ƒ

å½“å†™ä¸‹æ–°çš„å†…å®¹æ—¶ï¼Œç³»ç»Ÿèƒ½åšåˆ°æŒ‰éœ€è‡ªåŠ¨å‘å¸ƒã€‚é¦–å…ˆæƒ³åˆ°çš„æ˜¯git hookã€‚ä½¿ç”¨è…¾è®¯çš„æ··å…ƒå¤§æ¨¡å‹ã€‚ä»–æ˜¯è¿™æ ·å›ç­”çš„:

![Alt text](/asserts/githook1.png)


![Alt text](/asserts/githook2.png)

:::danger æ³¨æ„

æˆ‘çš„ä½¿ç”¨åœºæ™¯æ˜¯ï¼Œæˆ‘é€šè¿‡è¿œç¨‹sshè¿æ¥åˆ°æˆ‘çš„äº‘æœåŠ¡å™¨å†™blog,æˆ‘çš„ç½‘ç«™ä¹Ÿéƒ¨ç½²åœ¨æ­¤äº‘æœåŠ¡å™¨ä¸Š[^4]ã€‚

:::
æ¯”è¾ƒå…¨é¢äº†ã€‚

å¦‚æœç›´æ¥æŠŠæ„å»ºçš„è„šæœ¬å†™åœ¨post-commité‡Œé¢ï¼Œé‚£ä¹ˆæ¯æ¬¡commitçš„æ—¶å€™éƒ½è¦ç­‰å¾…30-40sç”¨äºæ„å»ºå‘å¸ƒã€‚è‹¥æŠŠå‘½ååŠ ä¸Š `nohup ...  &`è½¬åˆ°åå°è¿è¡Œï¼Œä½¿ç”¨å‘½ä»¤è¡Œæ•²commitæ—¶æ²¡æœ‰é—®é¢˜ï¼Œä½†ä½¿ç”¨vscode commitæ—¶ï¼Œæˆ‘å‘ç°å‘å¸ƒä»»åŠ¡åˆè·‘åˆ°å‰å°äº†ã€‚ã€‚ã€‚è¿˜æ˜¯è¦ç­‰ã€‚

è¿˜æœ‰ä¸€ç§æ–¹æ³•æ˜¯åˆ›å»ºå®šæ—¶ä»»åŠ¡ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´æ£€æŸ¥git commit çŠ¶æ€,å½“æœ‰æ–°çš„commitå°±å‘å¸ƒä¸€æ¬¡ï¼Œä½†è¿™æ ·ä¼šå¤±å»å®æ—¶æ€§ã€‚

å…¶å®ƒè¿˜æœ‰ä¸€äº›æ¯”è¾ƒæ²‰é‡çš„æ–¹æ³•å°±ä¸è€ƒè™‘äº†ã€‚

æˆ‘å†³å®šåœ¨æˆ‘çš„é™æ€web server é‡Œå†™ä¸€ä¸ªæ¥å£ï¼Œå®ç°å‘å¸ƒè¿‡ç¨‹ï¼›åœ¨post-commitå†™ä¸€ä¸ª curl å‘½ä»¤ï¼Œå½“commitçš„æ—¶å€™ï¼Œcurlå‘½ä»¤ä¼šå‘web server å‘ä¸€ä¸ªè¯·æ±‚ï¼Œä¹‹åç”±web server æ‰§è¡Œå‘å¸ƒçš„å…·ä½“æ­¥éª¤ï¼Œè¿™æ ·åšæ—¢å¯ä»¥åšåˆ°ï¼Œæ¯ä¸ªcommitå®æ—¶å‘å¸ƒï¼Œä¹Ÿä¸ä¼šè®©æˆ‘åœ¨commitçš„æ—¶å€™ç­‰å¾…å¤ªé•¿æ—¶é—´ã€‚

æˆ‘å®è·µä¹‹åå‘ç°å­˜åœ¨è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼š

1. web server å¼€å¯80 443ç«¯å£ï¼Œè¿™éœ€è¦rootæƒé™ã€‚
2. ä»¥rootæƒé™å¯åŠ¨çš„ç¨‹åº`system()`å‡½æ•°ä¹Ÿæ˜¯é»˜è®¤rootç”¨æˆ·ã€‚
3. å‘å¸ƒå·¥å…·bun ä¸€èˆ¬éƒ½æ˜¯åœ¨érootç”¨æˆ·ä¸‹ä½¿ç”¨ã€‚

æ‰€ä»¥ï¼Œè¿™å¯¼è‡´äº†å‘å¸ƒæ—¶çš„ä¸€äº›å¼‚å¸¸ï¼Œé¡µé¢æ— æ³•æ­£å¸¸è®¿é—®ã€‚æœ€åˆæˆ‘ä»¥ä¸ºæ˜¯æ–‡ä»¶æƒé™é—®é¢˜ï¼Œä½†æ”¹äº†æ–‡ä»¶æƒé™åï¼Œè¿˜æ˜¯æ— æ³•æ­£å¸¸è®¿é—®ï¼Œåæ¥å‘ç°æ˜¯åœ¨rootç”¨æˆ·ä¸‹ï¼Œæ‰§è¡Œå‘å¸ƒå‡ºç°äº†é—®é¢˜ï¼Œä¸€äº›å¼€å‘å·¥å…·é»˜è®¤ä¸åœ¨rootç”¨æˆ·ä¸‹è¿è¡Œã€‚

è¦è§£å†³è¿™æ ·çš„é—®é¢˜ï¼Œè€ƒè™‘ä»ä»¥ä¸‹æ–¹é¢ç€æ‰‹ï¼š

1. åˆ†æbunå‘å¸ƒé”™è¯¯çš„åŸå› ï¼Œä½¿bunå¯ä»¥åœ¨rootç”¨æˆ·ä¸‹æ­£å¸¸è¿è¡Œã€‚å¯èƒ½éœ€è¦åœ¨rootç”¨æˆ·ä¸‹å®‰è£…bunï¼Œè¿™æ˜¯ä¸æ¨èçš„ï¼Œæˆ‘ä¹Ÿä¸æƒ³æŠ˜è…¾è¿™ä¸ªã€‚
2. ä½¿ç”¨`system()`å‡½æ•°æ—¶åˆ‡æ¢åˆ°ä¸€èˆ¬ç”¨æˆ·ã€‚

æˆ‘å¯¹linuxå’Œbashä¸ç®—ç†Ÿæ‚‰ï¼Œæœ€åˆçš„æƒ³æ³•æ˜¯åœ¨shå‘½ä»¤ä¸­åˆ‡æ¢ç”¨æˆ·ï¼Œä½†è¿™æ¯”æˆ‘æƒ³è±¡ä¸­çš„éº»çƒ¦ï¼›äºæ˜¯è€ƒè™‘åœ¨linux cä»£ç ä¸­åˆ‡æ¢ç”¨æˆ·ã€‚ `setuid()`å¯ä»¥å®ç°ï¼Œå¯æ˜¯ä»…ä»…ä½¿ç”¨`setuid()`è¿˜æ˜¯ä¸è¡Œï¼Œç”¨æˆ·ç»„è¿˜æ˜¯ root ,ä¸€åˆ‡éƒ½æ²¡æœ‰æ”¹å˜ã€‚è€Œ`setgid()`åˆ‡æ¢ç»„ï¼Œubuntuä¸‹ä»rootç»„ä¸èƒ½åˆ‡æ¢åˆ°æ™®é€šç»„ï¼Œé”™è¯¯æç¤ºï¼š`Operation not permitted`ã€‚

::: tip Ai ç»™çš„åŸå› åˆ†æ

å½“ä½ åœ¨ Linux ç³»ç»Ÿä¸Šé‡åˆ° "Operation not permitted" é”™è¯¯ï¼Œç‰¹åˆ«æ˜¯åœ¨å°è¯•ä½¿ç”¨ `setgid()` å‡½æ•°æ—¶ï¼Œè¿™é€šå¸¸æ„å‘³ç€ä½ çš„è¿›ç¨‹æ²¡æœ‰è¶³å¤Ÿçš„æƒé™æ¥æ‰§è¡Œè¯¥æ“ä½œã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¯èƒ½çš„åŸå› å’Œè§£å†³æ–¹æ³•ï¼š

1. ä½ çš„è¿›ç¨‹ä¸æ˜¯ä»¥ root ç”¨æˆ·èº«ä»½è¿è¡Œçš„ã€‚`setgid()` å‡½æ•°è¦æ±‚è¿›ç¨‹å…·æœ‰ root æƒé™ï¼Œå› ä¸ºåªæœ‰ root ç”¨æˆ·æ‰èƒ½æ›´æ”¹è¿›ç¨‹çš„ç»„ IDã€‚å¦‚æœä½ æ— æ³•ä»¥ root ç”¨æˆ·èº«ä»½è¿è¡Œè¿›ç¨‹ï¼Œä½ å¯ä»¥å°è¯•ä½¿ç”¨ `sudo` å‘½ä»¤æ¥æå‡æƒé™ã€‚

2. ä½ çš„ç³»ç»Ÿå¯èƒ½å¯ç”¨äº†å®‰å…¨æ¨¡å—ï¼ˆå¦‚ SELinux æˆ– AppArmorï¼‰ï¼Œè¿™äº›æ¨¡å—å¯èƒ½ä¼šé™åˆ¶è¿›ç¨‹çš„æƒé™ï¼Œå¯¼è‡´ `setgid()` å¤±è´¥ã€‚ä½ å¯ä»¥æ£€æŸ¥ç³»ç»Ÿçš„æ—¥å¿—æ–‡ä»¶ï¼ˆå¦‚ `/var/log/audit/audit.log` æˆ– `/var/log/syslog`ï¼‰ï¼Œä»¥è·å–æœ‰å…³æƒé™é™åˆ¶çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚å¦‚æœä½ ç¡®å®šè¿™æ˜¯é—®é¢˜æ‰€åœ¨ï¼Œå¯ä»¥è€ƒè™‘è°ƒæ•´å®‰å…¨æ¨¡å—çš„ç­–ç•¥ï¼Œä»¥å…è®¸ä½ çš„è¿›ç¨‹æ‰§è¡Œ `setgid()` æ“ä½œã€‚

3. ä½ çš„è¿›ç¨‹å¯èƒ½å…·æœ‰äº†æ›´é«˜çš„æƒé™ï¼Œä½†åœ¨æ‰§è¡Œ `setgid()` æ—¶ï¼Œå†…æ ¸å¯èƒ½ä¼šé˜»æ­¢è¿™ç§æ“ä½œã€‚è¿™å¯èƒ½æ˜¯å› ä¸ºå†…æ ¸çš„ `Yama` å®‰å…¨æ¨¡å—ï¼Œå®ƒå¯èƒ½ä¼šé™åˆ¶ root ç”¨æˆ·è¿›ç¨‹çš„æƒé™ã€‚ä½ å¯ä»¥é€šè¿‡ç¼–è¾‘ `/etc/sysctl.conf` æ–‡ä»¶å¹¶æ·»åŠ ä»¥ä¸‹è¡Œæ¥ç¦ç”¨ Yama å®‰å…¨æ¨¡å—ï¼š

```
kernel.yama.ptrace_scope = 0
```

ç„¶åï¼Œè¿è¡Œ `sudo sysctl -p` å‘½ä»¤ä»¥åº”ç”¨æ›´æ”¹ã€‚è¯·æ³¨æ„ï¼Œç¦ç”¨ Yama å®‰å…¨æ¨¡å—å¯èƒ½ä¼šé™ä½ç³»ç»Ÿçš„å®‰å…¨æ€§ï¼Œå› æ­¤è¯·è°¨æ…æ“ä½œã€‚

4. å¦‚æœä½ åœ¨ä½¿ç”¨å®¹å™¨åŒ–æŠ€æœ¯ï¼ˆå¦‚ Docker æˆ– Kubernetesï¼‰æ—¶é‡åˆ°è¿™ä¸ªé—®é¢˜ï¼Œå¯èƒ½æ˜¯å› ä¸ºå®¹å™¨çš„å®‰å…¨è®¾ç½®é™åˆ¶äº†è¿›ç¨‹çš„æƒé™ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ éœ€è¦æ£€æŸ¥å®¹å™¨çš„é…ç½®æ–‡ä»¶ï¼Œä»¥ç¡®ä¿è¿›ç¨‹å…·æœ‰è¶³å¤Ÿçš„æƒé™æ¥æ‰§è¡Œ `setgid()` æ“ä½œã€‚ä½ å¯èƒ½éœ€è¦æ›´æ”¹å®¹å™¨çš„ç”¨æˆ·æˆ–ç»„ IDï¼Œæˆ–è€…è°ƒæ•´å®¹å™¨çš„å®‰å…¨è®¾ç½®ã€‚

:::


ç¬¬ä¸‰æ¡å’Œæˆ‘çš„æƒ…å†µéå¸¸åƒï¼Œä½†å®è·µä¹‹åï¼Œä¹Ÿæ²¡æœ‰æ•ˆæœã€‚äºæ˜¯ï¼Œæˆ‘è€ƒè™‘å…¶å®ƒåŠæ³•ã€‚

3. è®©ç¨‹åºåœ¨érootæƒé™ä¸‹ï¼Œå¯ä»¥æ‰“å¼€80ç«¯å£ï¼Œé—®äº†è…¾è®¯æ··å…ƒå¤§æ¨¡å‹ï¼Œå®ƒç»™çš„è§£å†³æ–¹æ³•ä¸æ€ä¹ˆå¥½ã€‚æœ€ç»ˆæˆ‘ä½¿ç”¨å‘½ä»¤ `sudo setcap 'cap_net_bind_service=+ep' /your program`ï¼Œå®ƒå¯ä»¥ä½¿ä¸€ä¸ªç¨‹åºåœ¨érootæƒé™ä¸‹ä½¿ç”¨80ã€443ç«¯å£ã€‚

æœ€ç»ˆæ•´ä¸ªåå°æ‰˜ç®¡ç¨‹åºæ˜¯è¿™æ ·çš„:

```cpp

#include <cerrno>
#include <chrono>
#include <condition_variable>
#include <drogon/HttpResponse.h>
#include <drogon/HttpTypes.h>
#include <drogon/drogon.h>
#include <drogon/utils/FunctionTraits.h>
#include <functional>
#include <iostream>
#include <json/value.h>
#include <pwd.h>
#include <stdlib.h>
#include <sys/types.h>
#include <unistd.h>
#include <string>
using namespace drogon;
int main(int argc, char *argv[]) {

  std::mutex _mux_blocking;
  std::condition_variable _build_conditon;

  std::thread j([&_mux_blocking, &_build_conditon]() {
    while (true) {
      std::unique_lock<std::mutex> ul(_mux_blocking);
      _build_conditon.wait(ul);

      if (setuid(1002) != -1 && setgid(1002) != -1) {
        system("cd /home/xxxxxxxx/git/my-site && "
               "/home/linuxbrew/.linuxbrew/bin/bun run docs:build ");
      }
      std::this_thread ::sleep_for(std::chrono::seconds(60));
    }
  });
  app()
      .setThreadNum(1)
      .registerSyncAdvice([](const HttpRequestPtr &req) -> HttpResponsePtr {
        auto port = req->getLocalAddr().toPort();
        if (port == 80) {
          auto resp = HttpResponse::newRedirectionResponse("https://zerlei.cn");
          return resp;
        } else {
          return nullptr;
        }
      })
      .addListener("0.0.0.0", 443, true,
                   "/home/xxxxxxxxx/.ssl/zerlei.cn_bundle.pem",
                   "/home/xxxxxxxxx/.ssl/zerlei.cn.key")
      .addListener("0.0.0.0", 80)
      .setDocumentRoot("./wwwroot")
      .registerHandler(
          "/xxxx?xx={xx}",
          [&_build_conditon](
              const HttpRequestPtr &req,
              std::function<void(const HttpResponsePtr &)> &&callback,
              const std::string &xx) {
            Json::Value res;
            if (xx == "xxxxxxxxxx") {
              _build_conditon.notify_all();
              res["message"] = "will build&release";
            } else {
              res["message"] = "ğŸ˜€";
            }
            callback(HttpResponse::newHttpJsonResponse(res));
          })
      .run();
}

```
`bun run docs:build` å°†ä¼šæ‰§è¡Œ `vitepress build && rm -rf /home/****/workspace/mysite/wwwroot/assets/*  && cp -r /home/****/git/my-site/.vitepress/dist/*  /home/****/workspace/mysite/wwwroot`

è¿™æ ·æ•´ä¸ªæµç¨‹æ˜¯ï¼Œæ¯æ¬¡commit åä¼šcurl web server å‘ä¸€ä¸ªhttp è¯·æ±‚ï¼Œå½“web serveræ¥æ”¶åˆ°ç›¸å…³è¯·æ±‚ä¹‹åï¼Œnotify ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œå¼‚æ­¥æ‰§è¡Œå‘å¸ƒï¼Œå¹¶ç«‹å³å‘curlè¯·æ±‚è¿”å›ç»“æœ,commit ä¸é˜»å¡å®Œæˆã€‚

## æœ€ç»ˆçš„æ•ˆæœ

æ­¤ç½‘ç«™å°±æ˜¯ä½ çœ‹åˆ°çš„æ ·å­~[^5]

[^1]: ä¸ªäººå¯ä»¥å…è´¹ç”³é¢†ã€‚æˆ‘ä½¿ç”¨çš„è…¾è®¯äº‘ï¼ŒåŒä¸€ä¸ªåŸŸåä¸‹ï¼Œå¯ä»¥åœ¨äºšæ´²è¯šä¿¡ç”³è¯· 20 ä¸ªè¯ä¹¦ï¼Œä¹Ÿå°±æ˜¯ 20 å¹´ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜æœ‰å…¶å®ƒåœ°æ–¹å¯ä»¥é¢†å…è´¹sslè¯ä¹¦ï¼Œå³ä½¿æ²¡æœ‰sslè¯ä¹¦ï¼Œå½±å“ä¹Ÿä¸å¤§ã€‚

[^2]: [vue å®˜ç½‘](https://cn.vuejs.org/),[vitepress å®˜ç½‘](https://vitepress.dev)ï¼Œ[naive-ui](https://www.naiveui.com) å…·ä½“æ­¥éª¤å‚è€ƒè¿™é‡Œ æ— éœ€å†—ä½™å™è¿°ã€‚æˆ‘è¿˜å­¦ä¹ äº†[vitepress-blog-zaun](https://github.com/clark-cui/vitepress-blog-zaun)çš„å†…å®¹ã€‚
[^3]: [drogon](https://github.com/drogonframework/drogon)æ˜¯ä¸€ä¸ªä½¿ç”¨c++å¼€å‘çš„httpåå°æ¡†æ¶ï¼Œå®ƒçš„ä¼˜ç‚¹æ˜¯è½»é‡å’Œé«˜æ€§èƒ½ï¼Œè€Œä¸”åŠŸèƒ½ååˆ†å…¨é¢ã€‚
[^4]: æˆ‘ä½¿ç”¨çš„è…¾è®¯äº‘ç»ˆèº«ç»­è´¹åŒä»·è½»é‡äº‘æœåŠ¡å™¨(4æ ¸-8GB-10M)ï¼Œä½¿ç”¨ä»£é‡‘åˆ¸ï¼Œä¸€å¹´è´¹ç”¨(75*12 = 900)å·¦å³
[^5]: [æºç ç›®å½•](https://github.com/ZhaoYouYa/my-site),å¯èƒ½ä¼šæ»åä¸€ç‚¹ã€‚
